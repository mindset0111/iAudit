<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Audit Demo (v10 - Precise Find)</title>
    <style>
        /* --- Base Styles --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
        }
	/* --- Base Styles --- */
        html {
            scroll-behavior: smooth;
        }
        body {

        .container {
            max-width: 95%;
            margin: auto;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
            overflow: hidden;
        }

        h1, h2, h3 {
            color: #1a3b5d;
            margin-top: 0;
        }

        h1 {
            text-align: center;
            padding: 25px;
            background-color: #0052cc;
            color: white;
            margin-bottom: 0;
            font-size: 2rem;
        }
        
        h2 {
            border-bottom: 2px solid #0052cc;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        section {
             padding: 25px 30px;
             border-bottom: 1px solid #e0e0e0;
        }
        section:last-child {
            border-bottom: none;
        }

        /* --- Header Wrapper (Score + Metadata) --- */
        .header-wrapper {
            display: flex;
            flex-wrap: wrap;
            padding: 0;
            border-bottom: 1px solid #e0e0e0;
        }

        /* --- Score Section (Left) --- */
        .total-score-section {
            flex: 1;
            padding: 30px;
            text-align: center;
            background-color: #fafbfc;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-right: 1px solid #e0e0e0;
            min-width: 200px;
        }
        .total-score-display {
            font-size: 4.5rem;
            font-weight: 700;
            color: #006644;
            line-height: 1.1;
        }
        .total-score-display span {
            font-size: 2rem;
            font-weight: 400;
            color: #505f79;
        }

        /* --- Metadata Section (Right) --- */
        .metadata-section {
            flex: 3;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
            background-color: #fafdff;
            min-width: 400px;
        }
        .metadata-item {
            display: flex;
            flex-direction: column;
        }
        .metadata-item label {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: #505f79;
        }
        .metadata-item input[readonly] {
            font-size: 1rem;
            font-weight: 500;
            padding: 10px;
            border: 1px solid #dfe1e6;
            border-radius: 5px;
            background-color: #fafbfc;
            color: #172b4d;
            cursor: default;
        }
        
        /* --- Audio Player --- */
        #call-audio {
            width: 100%;
        }

        /* --- Main Content (Transcript & NEW Analysis) --- */
        .content-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            padding: 35px 30px; 
        }

        /* --- Transcript Box (50%) --- */
        .transcript-section {
            flex: 1; 
            min-width: 300px;
            padding: 0;
            border: none;
        }

        #transcript-box {
            height: 400px; /* Fixed height */
            overflow-y: scroll;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #fdfdfd;
        }

        #transcript-box p {
            margin: 0 0 15px 0;
            padding: 12px;
            border-radius: 6px;
            transition: background-color 0.3s ease, border 0.3s ease;
            line-height: 1.6;
            cursor: pointer;
        }
        #transcript-box p:hover {
            background-color: #f4f4f4;
        }
        
        .speaker-agent { font-weight: bold; color: #0052cc; }
        .speaker-caller { font-weight: bold; color: #006644; }

        #transcript-box p.active {
            background-color: #e6f0ff;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 82, 204, 0.1);
        }
        
        #transcript-box p.highlight-param {
            background-color: #fffbdd !important;
            border: 1px solid #ffb400;
            box-shadow: 0 2px 8px rgba(255,180,0,0.3);
        }

        /* --- Audit Analysis Section (50%) --- */
        .audit-analysis-section {
            flex: 1; 
            min-width: 300px;
            padding: 0;
            border: none;
        }
        
        #analysis-box {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            height: 400px; /* Fixed height to match transcript */
            box-sizing: border-box;
            overflow-y: auto;
	    transition: box-shadow 0.3s ease-out, border-color 0.3s ease-out;
        }
	#analysis-box.highlight-analysis-box {
            box-shadow: 0 0 10px 4px rgba(0, 82, 204, 0.4);
            border-color: #0052cc;
        }
        
        /* Analysis Tabs */
        .analysis-tabs {
            display: flex;
            border-bottom: 2px solid #ccc;
            margin-bottom: 20px;
        }
        .analysis-tab {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            color: #505f79;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        .analysis-tab.active {
            color: #0052cc;
            border-bottom-color: #0052cc;
        }
        .analysis-tab:hover:not(.active) {
            background-color: #f4f4f4;
        }
        
        /* Analysis Content */
        .analysis-content { display: none; }
        .analysis-content.active { display: block; }
        
        /* Analysis Tables */
        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .analysis-table th, .analysis-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }
        .analysis-table th {
            background-color: #f4f7f6;
            color: #172b4d;
        }
        .analysis-table td { background-color: #fff; }
        .analysis-table .transcript-snippet {
            font-style: italic;
            color: #505f79;
        }
        .analysis-table .status-yes, .analysis-table .status-match {
            font-weight: bold;
            color: #006644;
        }
        .analysis-table .status-no, .analysis-table .status-fail {
            font-weight: bold;
            color: #D92929;
        }
        .analysis-table .data-label {
            font-weight: 600;
            color: #333;
        }
        
        .link-transcript-btn {
            font-size: 0.85rem;
            font-weight: 600;
            color: #0052cc;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: inline-block;
        }
        .link-transcript-btn:hover {
            background-color: #e6f0ff;
            text-decoration: underline;
        }


        /* --- Audit Form --- */
        .audit-form-section {
            background-color: #f4f7f6;
        }
        
        #audit-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .audit-item {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            background-color: #ffffff;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.3s ease, background-color 0.3s ease;
            cursor: pointer;
        }
        .audit-item.fail {
            border-color: #D92929;
            background-color: #fff8f7;
        }
        
        .audit-item:hover {
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.1);
        }
        .audit-item:not(.fail):hover {
            background-color: #fafdff;
        }
        
        .audit-item h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #172b4d;
        }
        
        .fields-container { display: grid; gap: 15px; }
        .field { display: flex; flex-direction: column; }
        
        .field label {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: #505f79;
        }
        
        .field input[type="text"],
        .field textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.95rem;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
            pointer-events: auto; 
            cursor: text;
        }
        
        .field input[type="text"]:focus,
        .field textarea:focus {
            border-color: #0052cc;
            box-shadow: 0 0 0 2px rgba(0, 82, 204, 0.2);
            outline: none;
        }

        .field textarea { 
            min-height: 100px; 
            resize: vertical; 
            background-color: #fafdff;
            color: #172b4d;
        }
        .field input[type="text"] {
             background-color: #fafdff;
             color: #172b4d;
        }
        .audit-item.fail textarea,
        .audit-item.fail input {
            border-color: #ffb8b0;
            background-color: #fff8f7;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>Smart Audit Demo</h1>
        
        <div class="header-wrapper">
            <section class="total-score-section">
                <h2>Total Score</h2>
                <div class="total-score-display">
                    31 <span>/ 40</span>
                </div>
            </section>
            
            <section class="metadata-section">
                <div class="metadata-item">
                    <label for="call-id">Call ID</label>
                    <input type="text" id="call-id" readonly>
                </div>
                <div class="metadata-item">
                    <label for="advisor-name">Advisor Name</label>
                    <input type="text" id="advisor-name" value="Agent (Next)" readonly>
                </div>
                <div class="metadata-item">
                    <label for="call-duration">Call Duration</label>
                    <input type="text" id="call-duration" value="00:00" readonly>
                </div>
                <div class="metadata-item">
                    <label for="call-intent">Call Intent</label>
                    <input type="text" id="call-intent" value="Make a Payment" readonly>
                </div>
            </section>
        </div>

        <section class="audio-section">
            <h2>Call Recording</h2>
            <audio id="call-audio" controls
                src="my_call.mp3">
                Your browser does not support the audio element.
            </audio>
        </section>

        <div class="content-wrapper">
            
            <section class="transcript-section">
                <h2>Call Transcript (Click any line to play)</h2>
                
                <div id="transcript-box">
                    <p data-start="5.72" data-end="8.72">
                        <span class="speaker-agent">AGENT:</span> Hello, good morning. You're through to the next. How may I help?
                    </p>
                    <p data-start="9.46" data-end="12.46" data-param="understanding-intent">
                        <span class="speaker-caller">CALLER:</span> Hello, yeah, can I make my monthly payment please?
                    </p>
                    <p data-start="12.42" data-end="14.22" data-param="understanding-intent">
                        <span class="speaker-agent">AGENT:</span> Of course, yes you can.
                    </p>
                    <p data-start="14.3" data-end="16.1" data-param="payment-query">
                        <span class="speaker-caller">CALLER:</span> Can you tell me how much it is?
                    </p>
                    <p data-start="16.36" data-end="17.76" data-param="understanding-query">
                        <span class="speaker-agent">AGENT:</span> Yes, I will.
                    </p>
                    <p data-start="18.91" data-end="20.67" data-param="dpa-name">
                        <span class="speaker-agent">AGENT:</span> Can I take your name?
                    </p>
                    <p data-start="20.88" data-end="22.6" data-param="dpa-name">
                        <span class="speaker-caller">CALLER:</span> Yes, Stacy Levy
                    </p>
                    <p data-start="23.54" data-end="25.18">
                        <span class="speaker-agent">AGENT:</span> Thank you. Let me quickly.
                    </p>
                    <p data-start="25.83" data-end="27.87">
                        <span class="speaker-agent">AGENT:</span> Getting onto your account OK.
                    </p>
                    <p data-start="28.24" data-end="28.76">
                        <span class="speaker-caller">CALLER:</span> Yep.
                    </p>
                    <p data-start="34.9" data-end="47.09" data-param="payment-query">
                        <span class="speaker-agent">AGENT:</span> Just pulling up the details and your balance shows 179.24 &pound;
                    </p>
                    <p data-start="47.51" data-end="48.03">
                        <span class="speaker-caller">CALLER:</span> Yeah.
                    </p>
                    <p data-start="49.19" data-end="51.07" data-param="payment-query">
                        <span class="speaker-agent">AGENT:</span> How much would you like to pay?
                    </p>
                    <p data-start="51.45" data-end="53.25" data-param="payment-query">
                        <span class="speaker-caller">CALLER:</span> What is my minimum required payment?
                    </p>
                    <p data-start="53.53" data-end="56.05" data-param="payment-query understanding-query">
                        <span class="speaker-agent">AGENT:</span> Minimum required payments &pound;9.
                    </p>
                    <p data-start="56.53" data-end="60.05" data-param="payment-confirm-amount">
                        <span class="speaker-caller">CALLER:</span> Oh no, can I pay &pound;20 please?
                    </p>
                    <p data-start="60.15" data-end="63.35" data-param="payment-confirm-amount understanding-confirm">
                        <span class="speaker-agent">AGENT:</span> 20 OK, let me quickly secure the line.
                    </p>
                    <p data-start="72.18" data-end="76.94" data-param="confidence-secure">
                        <span class="speaker-agent">AGENT:</span> Yes, the line is secure. Can you start typing the long card number manually on your phone?
                    </p>
                    <p data-start="77.42" data-end="77.92">
                        <span class="speaker-caller">CALLER:</span> Yes.
                    </p>
                    <p data-start="90.05" data-end="90.65">
                        <span class="speaker-caller">CALLER:</span> I've done it.
                    </p>
                    <p data-start="91.23" data-end="95.91">
                        <span class="speaker-agent">AGENT:</span> Thank you. Can you also enter the three digit security from the back of the card?
                    </p>
                    <p data-start="96.64" data-end="97.08">
                        <span class="speaker-caller">CALLER:</span> Yep.
                    </p>
                    <p data-start="100.52" data-end="101.04">
                        <span class="speaker-caller">CALLER:</span> Yes.
                    </p>
                    <p data-start="101.44" data-end="104.28">
                        <span class="speaker-agent">AGENT:</span> Can I take the expiry month and a year verbally?
                    </p>
                    <p data-start="104.96" data-end="106.56">
                        <span class="speaker-caller">CALLER:</span> 11/28.
                    </p>
                    <p data-start="108.43" data-end="108.71">
                        <span class="speaker-agent">AGENT:</span> Alright.
                    </p>
                    <p data-start="115.18" data-end="119.9" data-param="payment-advise-24h confidence-success">
                        <span class="speaker-agent">AGENT:</span> Yes, a payment of &pound;20 has been processed and this will show on your account by tomorrow.
                    </p>
                    <p data-start="120.52" data-end="123.0" data-param="confidence-success">
                        <span class="speaker-caller">CALLER:</span> OK. That's lovely. Thank you very much.
                    </p>
                    <p data-start="123.25" data-end="126.45">
                        <span class="speaker-agent">AGENT:</span> You're welcome. Anything else that we can resolve this morning?
                    </p>
                    <p data-start="126.31" data-end="128.75">
                        <span class="speaker-caller">CALLER:</span> No, that's lovely. Thank you.
                    </p>
                    <p data-start="129.01" data-end="132.49">
                        <span class="speaker-agent">AGENT:</span> You're welcome. Thank you. Thanks for your call. Bye. Bye.
                    </p>
                    <p data-start="129.39" data-end="130.55">
                        <span class="speaker-caller">CALLER:</span> Thanks. Bye.
                    </p>
                </div>
            </section>

            <section class="audit-analysis-section">
                <h2>Audit Analysis</h2>
                <div id="analysis-box">
                    </div>
            </section>
        </div>

        <section class="audit-form-section">
            <h2>Audit Checklist</h2>
            <form id="audit-form" onsubmit="return false;">
                <div class="audit-item" data-target="dpa">
                    <h3>DPA Verification</h3>
                    <div class="fields-container">
                        <div class="field">
                            <label for="dpa-results">Results</label>
                            <input type="text" id="dpa-results" value="Compliant Good Customer" placeholder="e.g., Pass / Fail">
                        </div>
                        <div class="field">
                            <label for="dpa-score">Score</label>
                            <input type="text" id="dpa-score" value="10/10" placeholder="e.g., 25/25">
                        </div>
                        <div class="field">
                            <label for="dpa-remarks">Remarks</label>
                            <textarea id="dpa-remarks" placeholder="AI Suggestion...">Agent asked for Name [18.91]. [DB_CHECK: PASSED] - Customer name "Stacy Levy" matches database. DPA rule (Name only) passed.</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="audit-item fail" data-target="payment">
                    <h3>Payment Process Followed</h3>
                    <div class="fields-container">
                        <div class="field">
                            <label for="payment-results">Results</label>
                            <input type="text" id="payment-results" value="Compliant with development" placeholder="e.g., N/A / Pass">
                        </div>
                        <div class="field">
                            <label for="payment-score">Score</label>
                            <input type="text" id="payment-score" value="1/10" placeholder="e.g., 25/25">
                        </div>
                        <div class="field">
                            <label for="payment-remarks">Remarks</label>
                            <textarea id="payment-remarks" placeholder="AI Suggestion...">Agent missed a mandatory script.
1. [DB_CHECK: PASSED] Payment for &pound;20 logged.
2. [SCRIPT_FAIL] Agent did NOT ask "Is the card registered...".
3. Amount (&pound;20) confirmed at [60.15].
4. 24-hour reflection advised at [115.18].</textarea>
                        </div>
                    </div>
                </div>

                <div class="audit-item" data-target="understanding">
                    <h3>Understanding customer</h3>
                    <div class="fields-container">
                        <div class="field">
                            <label for="understanding-results">Results</label>
                            <input type="text" id="understanding-results" value="Compliant Good Customer" placeholder="e.g., Pass">
                        </div>
                        <div class="field">
                            <label for="understanding-score">Score</label>
                            <input type="text" id="understanding-score" value="10/10" placeholder="e.g., 25/25">
                        </div>
                        <div class="field">
                            <label for="understanding-remarks">Remarks</label>
                            <textarea id="understanding-remarks" placeholder="AI Suggestion...">Agent understood customer's intent at [9.46], provided the total balance, answered the query about the minimum payment [53.53], and processed the customer's chosen amount.</textarea>
                        </div>
                    </div>
                </div>

                <div class="audit-item" data-target="confidence">
                    <h3>Instilling confidence</h3>
                    <div class="fields-container">
                        <div class="field">
                            <label for="confidence-results">Results</label>
                            <input type="text" id="confidence-results" value="Compliant Good Customer" placeholder="e.g., Pass">
                        </div>
                        <div class="field">
                            <label for="confidence-score">Score</label>
                            <input type="text" id="confidence-score" value="10/10" placeholder="e.g., 25/25">
                        </div>
                        <div class="field">
                            <label for="confidence-remarks">Remarks</label>
                            <textarea id="confidence-remarks" placeholder="AI Suggestion...">Agent used clear, professional language. Proactively stated "the line is secure" at [72.18] and gave a firm confirmation of success at [115.18], leading to a positive customer response [120.52].</textarea>
                        </div>
                    </div>
                </div>
            </form>
        </section>

    </div>

    <script>
        // --- Data store for the Audit Analysis Panel (UPDATED) ---
        const auditAnalysisData = {
            dpa: {
                title: 'DPA Verification',
                scriptValidation: [
                    // UPDATED: evidenceLink is now specific
                    { script: "Ask for customer's full name", checked: 'Yes', transcript: 'AGENT: Can I take your name? ... CALLER: Yes, Stacy Levy', evidenceLink: 'dpa-name' }
                ],
                dataValidation: [
                    { label: 'Name from Transcript', value: 'Stacy Levy' },
                    { label: 'Name from Database', value: 'Stacy Levy' },
                    { label: 'Matching', value: 'Yes', status: 'match' }
                ]
            },
            payment: {
                title: 'Payment Process',
                scriptValidation: [
                    // UPDATED: evidenceLinks are now specific
                    { script: 'Confirm payment amount', checked: 'Yes', transcript: 'CALLER: ...can I pay &pound;20 please? / AGENT: 20 OK...', evidenceLink: 'payment-confirm-amount' },
                    { script: 'Ask "Is card registered to billing address?"', checked: 'No', transcript: 'N/A - Script missed by agent.' },
                    { script: 'Advise 24-hour reflection time', checked: 'Yes', transcript: 'AGENT: ...this will show on your account by tomorrow.', evidenceLink: 'payment-advise-24h' }
                ],
                dataValidation: [
                    { label: 'Amount from Transcript', value: '&pound;20' },
                    { label: 'Amount from Database (Payment Log)', value: '&pound;20' },
                    { label: 'Matching', value: 'Yes', status: 'match' },
                    { label: 'Payment Status', value: 'Successful', status: 'match' }
                ]
            },
            understanding: {
                title: 'Understanding Customer',
                scriptValidation: [
                    // UPDATED: evidenceLinks are now specific
                    { script: 'Acknowledge initial intent', checked: 'Yes', transcript: 'AGENT: Of course, yes you can.', evidenceLink: 'understanding-intent' },
                    { script: 'Answer query (minimum payment)', checked: 'Yes', transcript: 'AGENT: Minimum required payments &pound;9.', evidenceLink: 'understanding-query' },
                    { script: 'Acknowledge chosen amount', checked: 'Yes', transcript: 'AGENT: 20 OK, let me quickly secure the line.', evidenceLink: 'understanding-confirm' }
                ],
                dataValidation: []
            },
            confidence: {
                title: 'Instilling Confidence',
                scriptValidation: [
                    // UPDATED: evidenceLinks are now specific
                    { script: 'State line is secure', checked: 'Yes', transcript: 'AGENT: Yes, the line is secure.', evidenceLink: 'confidence-secure' },
                    { script: 'Confirm payment success', checked: 'Yes', transcript: 'AGENT: Yes, a payment of &pound;20 has been processed...', evidenceLink: 'confidence-success' }
                ],
                dataValidation: []
            }
        };


        document.addEventListener('DOMContentLoaded', () => {
            const audio = document.getElementById('call-audio');
            const transcriptContainer = document.getElementById('transcript-box');
            const transcriptLines = transcriptContainer.querySelectorAll('p[data-start]');
            const allParamLines = transcriptContainer.querySelectorAll('p[data-param]');
            const auditItems = document.querySelectorAll('.audit-item');
            const analysisBox = document.getElementById('analysis-box');
            
            let currentActiveLine = null;
            let highlightTimer = null; 

            // --- Generate Random Call ID ---
            function generateCallId(length) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }
            document.getElementById('call-id').value = generateCallId(16);

            // --- Get Call Duration on load ---
            audio.addEventListener('loadedmetadata', () => {
                 const duration = audio.duration;
                 if (duration && isFinite(duration)) {
                    const minutes = Math.floor(duration / 60);
                    const seconds = Math.floor(duration % 60);
                    document.getElementById('call-duration').value = 
                        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                 }
            });
            audio.addEventListener('error', () => {
                console.warn('Audio file not found or failed to load. Make sure "my_call.mp3" is in the same folder as this HTML file.');
                document.getElementById('call-duration').value = "Error";
                alert('Audio file "my_call.mp3" not found!\n\nPlease make sure it is in the same folder as this HTML file and named correctly.');
            });


            // --- Transcript Sync Logic (Audio Playing) ---
            audio.addEventListener('timeupdate', () => {
                const currentTime = audio.currentTime;
                let foundActiveLine = false;

                transcriptLines.forEach(line => {
                    const startTime = parseFloat(line.dataset.start);
                    const endTime = parseFloat(line.dataset.end);

                    if (currentTime >= startTime && currentTime <= endTime) {
                        foundActiveLine = true;
                        
                        if (line !== currentActiveLine) {
                            if (currentActiveLine) {
                                currentActiveLine.classList.remove('active');
                            }
                            line.classList.add('active');
                            currentActiveLine = line;

                            if (!line.classList.contains('highlight-param')) {
                                line.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'center'
                                });
                            }
                        }
                    } else {
                        line.classList.remove('active');
                    }
                });
                
                if (!foundActiveLine && currentActiveLine) {
                     currentActiveLine.classList.remove('active');
                     currentActiveLine = null;
                }
            });

            audio.addEventListener('ended', () => {
                if (currentActiveLine) {
                    currentActiveLine.classList.remove('active');
                    currentActiveLine = null;
                }
            });

            
            // --- Event listener for the whole audit item box ---
	    let highlightAnalysisBoxTimer = null;
            auditItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    // Check if the click was on an editable field. If so, do nothing.
                    const isField = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'LABEL';
                    
                    if (isField) {
                        e.target.focus();
                        return;
                    }

                    // If click was on the box padding or H3, just populate analysis
                    const targetParam = e.currentTarget.dataset.target;
                    populateAnalysis(targetParam);
		    highlightAnalysisPanel();
                });
            });

            // --- Event listener for [Find] links in the analysis panel ---
            analysisBox.addEventListener('click', (e) => {
                if (e.target.classList.contains('link-transcript-btn')) {
                    e.stopPropagation();
                    const targetParam = e.target.dataset.target;
                    
                    // The [Find] link now *only* highlights. 
                    // The analysis is already populated.
                    highlightTranscript(targetParam);
                }
            });
            
	    // --- NEW: Function to scroll to and highlight analysis panel ---
            function highlightAnalysisPanel() {
                // Scroll the analysis section into view
                analysisBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Add highlight
                analysisBox.classList.add('highlight-analysis-box');
                
                // Clear any existing timer
                if (highlightAnalysisBoxTimer) {
                    clearTimeout(highlightAnalysisBoxTimer);
                }
                
                // Remove highlight after 1.5 seconds
                highlightAnalysisBoxTimer = setTimeout(() => {
                    analysisBox.classList.remove('highlight-analysis-box');
                }, 1500);
            }
            // --- Function to ONLY highlight transcript ---
            function highlightTranscript(targetParam) {
                clearAllHighlights();
                if(highlightTimer) clearTimeout(highlightTimer);

                // UPDATED: Now looks for the specific data-param
                const matchingLines = transcriptContainer.querySelectorAll(`p[data-param*="${targetParam}"]`);
                
                if (matchingLines.length > 0) {
                    matchingLines.forEach(line => {
                        line.classList.add('highlight-param');
                    });
                    
                    matchingLines[0].scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    
                    highlightTimer = setTimeout(clearAllHighlights, 4000);
                } else {
                    console.warn(`No transcript lines found for parameter: ${targetParam}`);
                }
            }
            
            function clearAllHighlights() {
                allParamLines.forEach(line => {
                    line.classList.remove('highlight-param');
                });
            }

            // --- Click-to-Play Transcript ---
            transcriptLines.forEach(line => {
                line.addEventListener('click', (e) => {
                    // Stop click-to-play if we are clicking a [Find] link
                    if (e.target.classList.contains('link-transcript-btn')) {
                        return;
                    }
                    const jumpTime = parseFloat(line.dataset.start);
                    if (!isNaN(jumpTime)) {
                        audio.currentTime = jumpTime;
                        audio.play();
                    }
                });
            });
            
            
            // --- Functions to build and populate the analysis panel ---
            
            function populateAnalysis(param) {
                const data = auditAnalysisData[param];
                if (!data) return;

                let scriptHtml = buildScriptTable(data.scriptValidation);
                let dataHtml = buildDataTable(data.dataValidation);
                
                let hasDataValidation = data.dataValidation && data.dataValidation.length > 0;
                
                let dataTabVisibility = hasDataValidation ? '' : 'style="display: none;"';

                let html = `
                    <h3>${data.title}</h3>
                    <div class="analysis-tabs">
                        <div class="analysis-tab active" data-tab="script">Script Validation</div>
                        <div class="analysis-tab" data-tab="data" ${dataTabVisibility}>Data Validation</div>
                    </div>
                    
                    <div id="script-content" class="analysis-content active">
                        ${scriptHtml}
                    </div>
                    <div id="data-content" class="analysis-content">
                        ${dataHtml}
                    </div>
                `;
                
                analysisBox.innerHTML = html;
                addTabListeners();
            }
            
            function buildScriptTable(scripts) {
                if (!scripts || scripts.length === 0) return '<p>No script validation for this parameter.</p>';
                
                let rows = scripts.map(item => {
                    let statusClass = item.checked === 'Yes' ? 'status-yes' : 'status-no';
                    // UPDATED: [Find] link is now built here with the specific evidenceLink
                    let linkHtml = item.evidenceLink ? `<span class="link-transcript-btn" data-target="${item.evidenceLink}">[Find]</span>` : '';
                    
                    return `
                        <tr>
                            <td>${item.script}</td>
                            <td class="${statusClass}">${item.checked}</td>
                            <td class="transcript-snippet">${item.transcript}</td>
                            <td>${linkHtml}</td>
                        </tr>
                    `;
                }).join('');
                
                return `
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                <th>Mandatory Script / Action</th>
                                <th>Checked?</th>
                                <th>Transcript Evidence</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                `;
            }

            function buildDataTable(dataItems) {
                if (!dataItems || dataItems.length === 0) return '<p>No data validation for this parameter.</p>';
                
                let rows = dataItems.map(item => {
                    let statusClass = '';
                    if (item.status === 'match') statusClass = 'status-match';
                    if (item.status === 'fail') statusClass = 'status-fail';
                    
                    return `
                        <tr>
                            <td class="data-label">${item.label}</td>
                            <td class="${statusClass}">${item.value}</td>
                        </tr>
                    `;
                }).join('');
                
                return `
                    <table class="analysis-table">
                        <thead>
                            <tr>
                                <th>Data Point</th>
                                <th>Value / Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                `;
            }
            
            function addTabListeners() {
                const tabs = analysisBox.querySelectorAll('.analysis-tab');
                const contents = analysisBox.querySelectorAll('.analysis-content');
                
                tabs.forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        e.stopPropagation(); // Stop click from bubbling up to the .audit-item
                        tabs.forEach(t => t.classList.remove('active'));
                        contents.forEach(c => c.classList.remove('active'));
                        
                        tab.classList.add('active');
                        const contentId = `${tab.dataset.tab}-content`;
                        analysisBox.querySelector(`#${contentId}`).classList.add('active');
                    });
                });
            }

            // --- Load DPA analysis by default ---
            populateAnalysis('dpa');
        });
    </script>

</body>
</html>